<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      .container {
        padding: 10px;
        font-family: Arial, sans-serif;
      }
      .form-group {
        margin-bottom: 15px;
      }
      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }
      select, button {
        width: 100%;
        padding: 8px;
        margin-bottom: 10px;
      }
      button {
        background-color: #4CAF50;
        color: white;
        border: none;
        cursor: pointer;
      }
      button:hover {
        background-color: #45a049;
      }
      .conflict-panel {
        margin-top: 20px;
        display: none;
      }
      .conflict-item {
        border: 1px solid #ddd;
        padding: 10px;
        margin-bottom: 10px;
      }
      .conflict-actions {
        display: flex;
        gap: 10px;
        margin-top: 10px;
      }
      .conflict-actions button {
        flex: 1;
      }
      .source-value, .target-value {
        background-color: #f5f5f5;
        padding: 5px;
        margin: 5px 0;
      }
      .status {
        margin-top: 10px;
        padding: 10px;
        display: none;
      }
      .success {
        background-color: #dff0d8;
        color: #3c763d;
      }
      .error {
        background-color: #f2dede;
        color: #a94442;
      }
      #skeleton {
        display: block;
      }
      #content {
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- 加载状态 -->
      <div id="skeleton">
        <p>加载中...</p>
      </div>
      
      <!-- 主要内容 -->
      <div id="content">
        <div class="form-group">
          <label for="sourceSheet">源表格:</label>
          <select id="sourceSheet"></select>
        </div>
        <div class="form-group">
          <label for="targetSheet">目标表格:</label>
          <select id="targetSheet"></select>
        </div>
        <button onclick="runMerge()">开始合并</button>
        
        <div id="status" class="status"></div>
        
        <div id="conflictPanel" class="conflict-panel">
          <h3>需要解决的冲突</h3>
          <div id="conflicts"></div>
        </div>
      </div>
    </div>
    
    <script>
      // 缓存DOM元素
      const elements = {
        sourceSheet: null,
        targetSheet: null,
        status: null,
        skeleton: null,
        content: null,
        conflictPanel: null,
        conflicts: null
      };
      
      // 状态管理
      const state = {
        isLoading: false,
        sheets: null
      };
      
      // 初始化函数
      function init() {
        // 缓存DOM元素
        elements.sourceSheet = document.getElementById('sourceSheet');
        elements.targetSheet = document.getElementById('targetSheet');
        elements.status = document.getElementById('status');
        elements.skeleton = document.getElementById('skeleton');
        elements.content = document.getElementById('content');
        elements.conflictPanel = document.getElementById('conflictPanel');
        elements.conflicts = document.getElementById('conflicts');
        
        // 加载表格信息
        loadSheetInfo();
      }
      
      // 加载表格信息
      function loadSheetInfo() {
        if (state.isLoading) return;
        state.isLoading = true;
        
        google.script.run
          .withSuccessHandler(function(result) {
            loadSheets(result.sheets);
            showContent();
            state.isLoading = false;
          })
          .withFailureHandler(function(error) {
            showStatus('加载失败: ' + error, true);
            state.isLoading = false;
          })
          .getSheetInfo();
      }
      
      // 显示主要内容
      function showContent() {
        elements.skeleton.style.display = 'none';
        elements.content.style.display = 'block';
      }
      
      // 加载表格选项
      function loadSheets(sheets) {
        state.sheets = sheets;
        
        // 清空现有选项
        elements.sourceSheet.innerHTML = '';
        elements.targetSheet.innerHTML = '';
        
        // 添加默认选项
        elements.sourceSheet.add(new Option('请选择源表格...', ''));
        elements.targetSheet.add(new Option('请选择目标表格...', ''));
        
        // 添加表格选项
        sheets.forEach(function(sheet) {
          elements.sourceSheet.add(new Option(sheet, sheet));
          elements.targetSheet.add(new Option(sheet, sheet));
        });
      }
      
      // 运行合并
      function runMerge() {
        var sourceSheet = elements.sourceSheet.value;
        var targetSheet = elements.targetSheet.value;
        
        if (!sourceSheet || !targetSheet) {
          showStatus('请选择源表格和目标表格', true);
          return;
        }
        
        if (sourceSheet === targetSheet) {
          showStatus('源表格和目标表格不能相同', true);
          return;
        }
        
        var config = {
          sourceSheet: sourceSheet,
          targetSheet: targetSheet
        };
        
        showStatus('正在合并...', false);
        
        google.script.run
          .withSuccessHandler(handleMergeSuccess)
          .withFailureHandler(handleMergeError)
          .mergeSheets(config);
      }
      
      // 处理合并成功
      function handleMergeSuccess(result) {
        if (!result.success) {
          showStatus(result.message, true);
          return;
        }
        
        showStatus(result.message, false);
        
        if (result.result && result.result.conflicts.length > 0) {
          showConflicts(result.result.conflicts);
        }
      }
      
      // 处理合并错误
      function handleMergeError(error) {
        showStatus('合并失败: ' + error, true);
      }
      
      // 显示冲突
      function showConflicts(conflicts) {
        elements.conflictPanel.style.display = 'block';
        elements.conflicts.innerHTML = '';
        
        conflicts.forEach(function(conflict, index) {
          var conflictDiv = document.createElement('div');
          conflictDiv.className = 'conflict-item';
          conflictDiv.innerHTML = `
            <div>位置: 第${conflict.row + 1}行, 第${conflict.col + 1}列</div>
            <div class="source-value">源值: ${conflict.sourceValue}</div>
            <div class="target-value">目标值: ${conflict.targetValue}</div>
            <div class="conflict-actions">
              <button onclick="resolveConflict(${index}, ${conflict.row}, ${conflict.col}, '${conflict.sourceValue}')">
                使用源值
              </button>
              <button onclick="resolveConflict(${index}, ${conflict.row}, ${conflict.col}, '${conflict.targetValue}')">
                使用目标值
              </button>
            </div>
          `;
          elements.conflicts.appendChild(conflictDiv);
        });
      }
      
      // 解决冲突
      function resolveConflict(index, row, col, value) {
        var targetSheet = elements.targetSheet.value;
        var config = {
          sheet: targetSheet,
          row: row + 1,
          col: col + 1,
          value: value
        };
        
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              var conflictItem = document.getElementsByClassName('conflict-item')[index];
              conflictItem.style.display = 'none';
              showStatus('已解决一个冲突', false);
            } else {
              showStatus(result.message, true);
            }
          })
          .withFailureHandler(function(error) {
            showStatus('解决冲突失败: ' + error, true);
          })
          .resolveConflict(config);
      }
      
      // 显示状态信息
      function showStatus(message, isError) {
        var status = elements.status;
        status.textContent = message;
        status.className = 'status ' + (isError ? 'error' : 'success');
        status.style.display = 'block';
      }
      
      // 页面加载完成后初始化
      google.script.onload = init;
    </script>
  </body>
</html>
